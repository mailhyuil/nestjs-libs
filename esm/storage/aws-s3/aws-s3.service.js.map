{"version":3,"sources":["../../../src/storage/aws-s3/aws-s3.service.ts"],"sourcesContent":["import {\r\n  DeleteObjectCommand,\r\n  DeleteObjectsCommand,\r\n  ListObjectsV2Command,\r\n  PutObjectCommand,\r\n  S3Client,\r\n} from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\nimport {\r\n  AWS_S3_MODULE_OPTIONS,\r\n  AwsS3DeleteFailedException,\r\n  AwsS3GetPresignedUrlFailedException,\r\n  AwsS3ListFailedException,\r\n  AwsS3ModuleOptionsType,\r\n  AwsS3UploadFailedException,\r\n  IStorageService,\r\n} from '@mailhyuil/nestjs-libs';\r\nimport {\r\n  Inject,\r\n  Injectable,\r\n  InternalServerErrorException,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { Request } from 'express';\r\nimport path from 'path';\r\n\r\n@Injectable()\r\nexport class AwsS3Service implements IStorageService {\r\n  private readonly logger = new Logger(AwsS3Service.name);\r\n  s3: S3Client;\r\n  constructor(\r\n    @Inject(AWS_S3_MODULE_OPTIONS)\r\n    private readonly options: AwsS3ModuleOptionsType,\r\n  ) {\r\n    Object.keys(this.options).forEach((key) => {\r\n      const unsetValues: string[] = [];\r\n      if (!this.options[key]) {\r\n        unsetValues.push(key);\r\n      }\r\n      if (unsetValues.length > 0) {\r\n        throw new InternalServerErrorException(\r\n          `AWS S3 설정이 필요합니다. Unset Values : [${unsetValues.join(\r\n            ', ',\r\n          )}]`,\r\n        );\r\n      }\r\n    });\r\n    this.s3 = new S3Client({\r\n      region: this.options.region,\r\n      credentials: {\r\n        accessKeyId: this.options.accessKeyId,\r\n        secretAccessKey: this.options.secretAccessKey,\r\n      },\r\n    });\r\n  }\r\n\r\n  async upload(name: string, buffer: Buffer) {\r\n    const ext = path.extname(name);\r\n    const basename = path.basename(name, ext);\r\n    const key = `original/${basename}_${Date.now()}${ext}`;\r\n\r\n    const command = new PutObjectCommand({\r\n      Bucket: this.options.bucket,\r\n      Key: key,\r\n      Body: buffer,\r\n    });\r\n    await this.s3.send(command).catch((error) => {\r\n      throw new AwsS3UploadFailedException(error);\r\n    });\r\n    return { key };\r\n  }\r\n\r\n  uploadByStream(req: Request) {\r\n    return new Promise<{ key: string }>((resolve, reject) => {\r\n      req.pipe(req.busboy);\r\n      req.busboy.on('file', (name, file) => {\r\n        const ext = path.extname(name);\r\n        const basename = path.basename(name, ext);\r\n        const key = `original/${basename}_${Date.now()}${ext}`;\r\n        const command = new PutObjectCommand({\r\n          Bucket: this.options.bucket,\r\n          Key: key,\r\n          Body: file,\r\n        });\r\n        this.s3\r\n          .send(command)\r\n          .then(() => {\r\n            resolve({ key });\r\n          })\r\n          .catch((error) => {\r\n            reject(new AwsS3UploadFailedException(error));\r\n          });\r\n      });\r\n    });\r\n  }\r\n\r\n  async delete(key: string) {\r\n    const command = new DeleteObjectCommand({\r\n      Bucket: this.options.bucket,\r\n      Key: key,\r\n    });\r\n    await this.s3.send(command).catch((error) => {\r\n      throw new AwsS3DeleteFailedException(error);\r\n    });\r\n  }\r\n\r\n  async deleteAll(urls: string[]) {\r\n    const command = new DeleteObjectsCommand({\r\n      Bucket: this.options.bucket,\r\n      Delete: {\r\n        Objects: urls.map((url) => ({\r\n          Key: url.replace(this.options.cloudfrontDomain + '/', ''),\r\n        })),\r\n        Quiet: false,\r\n      },\r\n    });\r\n    const res = await this.s3.send(command).catch((error) => {\r\n      throw new AwsS3DeleteFailedException(error);\r\n    });\r\n\r\n    this.logger.log(`\r\n    ${res.Deleted?.length}개 파일이 삭제되었습니다.\r\n`);\r\n  }\r\n\r\n  async getPresignedUrl({ key }: { key: string }) {\r\n    const command = new PutObjectCommand({\r\n      Bucket: this.options.bucket,\r\n      Key: key,\r\n    });\r\n    const url = await getSignedUrl(this.s3, command, { expiresIn: 3600 }).catch(\r\n      (error) => {\r\n        this.logger.error(error);\r\n        throw new AwsS3GetPresignedUrlFailedException(error);\r\n      },\r\n    );\r\n    return { url };\r\n  }\r\n\r\n  async list() {\r\n    const command = new ListObjectsV2Command({\r\n      Bucket: this.options.bucket,\r\n    });\r\n\r\n    const { Contents } = await this.s3.send(command).catch((error) => {\r\n      throw new AwsS3ListFailedException(error);\r\n    });\r\n\r\n    if (!Contents) return [];\r\n\r\n    const keys =\r\n      Contents.map((content) => content.Key).filter(\r\n        (key) => typeof key !== 'undefined',\r\n      ) || [];\r\n    return keys;\r\n  }\r\n}\r\n"],"names":["DeleteObjectCommand","DeleteObjectsCommand","ListObjectsV2Command","PutObjectCommand","S3Client","getSignedUrl","AWS_S3_MODULE_OPTIONS","AwsS3DeleteFailedException","AwsS3GetPresignedUrlFailedException","AwsS3ListFailedException","AwsS3ModuleOptionsType","AwsS3UploadFailedException","Inject","Injectable","InternalServerErrorException","Logger","path","AwsS3Service","upload","name","buffer","ext","extname","basename","key","Date","now","command","Bucket","options","bucket","Key","Body","s3","send","catch","error","uploadByStream","req","Promise","resolve","reject","pipe","busboy","on","file","then","delete","deleteAll","urls","Delete","Objects","map","url","replace","cloudfrontDomain","Quiet","res","logger","log","Deleted","length","getPresignedUrl","expiresIn","list","Contents","keys","content","filter","constructor","Object","forEach","unsetValues","push","join","region","credentials","accessKeyId","secretAccessKey"],"mappings":"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"}